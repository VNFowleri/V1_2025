{% extends "base.html" %}
{% block content %}
<style>
.consent-form-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
}

.consent-header {
    text-align: center;
    border-bottom: 2px solid #333;
    padding-bottom: 15px;
    margin-bottom: 25px;
}

.consent-header h1 {
    font-size: 18px;
    font-weight: bold;
    margin: 0 0 5px 0;
    text-transform: uppercase;
}

.consent-header h2 {
    font-size: 14px;
    margin: 5px 0;
    color: #555;
}

.form-section {
    margin-bottom: 25px;
    padding: 15px;
    background: #f9f9f9;
    border-left: 4px solid #007bff;
}

.form-section h3 {
    font-size: 14px;
    font-weight: bold;
    margin: 0 0 12px 0;
    text-transform: uppercase;
    color: #333;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 12px;
}

.form-field {
    margin-bottom: 10px;
}

.form-field label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    color: #555;
    margin-bottom: 4px;
}

.form-field .value {
    font-size: 13px;
    padding: 6px;
    background: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    min-height: 28px;
}

.checkbox-section {
    margin: 8px 0;
}

.checkbox-item {
    display: flex;
    align-items: flex-start;
    margin: 8px 0;
    padding: 8px;
    background: white;
    border-radius: 4px;
}

.checkbox-item input[type="checkbox"] {
    margin-right: 10px;
    margin-top: 3px;
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.checkbox-item label {
    flex: 1;
    font-size: 12px;
    line-height: 1.4;
    cursor: pointer;
}

.initial-required {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px;
    background: #fff3cd;
    border-radius: 4px;
    margin: 8px 0;
}

.initial-required input[type="text"] {
    width: 80px;
    padding: 4px 8px;
    border: 1px solid #856404;
    border-radius: 4px;
    font-size: 12px;
}

.initial-required label {
    flex: 1;
    font-size: 12px;
    color: #856404;
    font-weight: 500;
}

.acknowledgment-text {
    font-size: 11px;
    line-height: 1.6;
    color: #444;
    margin: 6px 0;
    padding: 8px;
    background: white;
    border-radius: 4px;
}

.acknowledgment-text strong {
    font-weight: 600;
    color: #333;
}

.signature-section {
    margin-top: 30px;
    padding: 20px;
    background: #f0f8ff;
    border: 2px dashed #007bff;
    border-radius: 8px;
}

.signature-section h3 {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 15px;
    color: #333;
}

.signature-canvas-container {
    background: white;
    border: 2px solid #333;
    border-radius: 4px;
    margin: 15px 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#sigpad {
    display: block;
    touch-action: none;
    cursor: crosshair;
}

.signature-controls {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.date-signed {
    font-size: 12px;
    color: #666;
    margin-top: 10px;
}

.notice-box {
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 4px;
    padding: 12px;
    margin: 15px 0;
    font-size: 11px;
    line-height: 1.5;
}

.notice-box strong {
    display: block;
    margin-bottom: 5px;
    color: #856404;
}

.submit-section {
    margin-top: 30px;
    text-align: center;
    padding: 20px;
    background: #f9f9f9;
    border-radius: 8px;
}

.btn-submit {
    background: #28a745;
    color: white;
    padding: 12px 40px;
    font-size: 16px;
    font-weight: 600;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s;
}

.btn-submit:hover {
    background: #218838;
}

.btn-submit:disabled {
    background: #6c757d;
    cursor: not-allowed;
}

.btn-secondary {
    background: #6c757d;
    color: white;
    padding: 8px 20px;
    font-size: 14px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.btn-secondary:hover {
    background: #5a6268;
}
</style>

<div class="consent-form-container">
    <!-- Header -->
    <div class="consent-header">
        <h1>Authorization for Release of Protected or Privileged Health Information</h1>
        <h2>and Patient-Directed Access Request (Veritas One, Inc.)</h2>
        <p style="font-size: 11px; margin-top: 10px; color: #666;">
            Please review all information carefully before signing
        </p>
    </div>

    <form method="post" action="" onsubmit="return submitConsent()">
        <!-- Section A: Patient Information -->
        <div class="form-section">
            <h3>A. Patient Information</h3>
            <div class="form-row">
                <div class="form-field">
                    <label>Patient Name:</label>
                    <div class="value">{{ patient.first_name }} {{ patient.last_name }}</div>
                </div>
                <div class="form-field">
                    <label>Date of Birth:</label>
                    <div class="value">{{ patient.date_of_birth if patient.date_of_birth else "Not provided" }}</div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-field">
                    <label>Preferred Phone:</label>
                    <div class="value">{{ patient.phone if patient.phone else "Not provided" }}</div>
                </div>
                <div class="form-field">
                    <label>Email:</label>
                    <div class="value">{{ patient.email if patient.email else "Not provided" }}</div>
                </div>
            </div>
        </div>

        <!-- Section B: Permission to Share -->
        <div class="form-section">
            <h3>B. Permission to Share</h3>
            <div class="form-field">
                <label>Records FROM (will be specified when you select providers):</label>
                <div class="value">Healthcare providers you select in the next step</div>
            </div>
            <div class="form-field">
                <label>Send records TO:</label>
                <div class="value">
                    <strong>Veritas One, Inc.</strong> — acting as your agent to receive, consolidate, and deliver records to you<br>
                    Secure return methods: Fax, encrypted email, or secure upload
                </div>
            </div>
        </div>

        <!-- Section C: Information to be Released -->
        <div class="form-section">
            <h3>C. Information to be Released</h3>
            <p style="font-size: 11px; margin-bottom: 12px;">Check all that apply:</p>

            <div class="checkbox-section">
                <div class="checkbox-item">
                    <input type="checkbox" id="all_records" name="records_all" checked>
                    <label for="all_records">
                        <strong>ALL RECORDS (Designated Record Set), ALL DATES</strong><br>
                        Includes clinical + billing; radiology reports & images
                    </label>
                </div>

                <div class="checkbox-item">
                    <input type="checkbox" id="medical_abstract" name="records_abstract">
                    <label for="medical_abstract">
                        Medical record abstract (H&P, operative reports, consults, test reports, discharge summaries)
                    </label>
                </div>

                <div class="checkbox-item">
                    <input type="checkbox" id="clinic_notes" name="records_clinic">
                    <label for="clinic_notes">Clinic / visit notes</label>
                </div>

                <div class="checkbox-item">
                    <input type="checkbox" id="lab" name="records_lab">
                    <label for="lab">Laboratory results</label>
                </div>

                <div class="checkbox-item">
                    <input type="checkbox" id="radiology" name="records_radiology">
                    <label for="radiology">Radiology REPORTS and IMAGES (DICOM/CD acceptable)</label>
                </div>

                <div class="checkbox-item">
                    <input type="checkbox" id="billing" name="records_billing">
                    <label for="billing">Billing / claims information</label>
                </div>
            </div>
        </div>

        <!-- Section D: Sensitive Information -->
        <div class="form-section">
            <h3>D. Sensitive Information — Release Only If Initialed</h3>
            <p style="font-size: 11px; margin-bottom: 12px; color: #856404; font-weight: 500;">
                ⚠️ The following categories require your initials to be released:
            </p>

            <div class="initial-required">
                <input type="text" id="initial_hiv" name="initial_hiv" maxlength="3" placeholder="___">
                <label for="initial_hiv">
                    <strong>HIV/AIDS</strong> testing, diagnosis, or treatment — Initials required
                </label>
            </div>

            <div class="initial-required">
                <input type="text" id="initial_genetic" name="initial_genetic" maxlength="3" placeholder="___">
                <label for="initial_genetic">
                    <strong>Genetic testing/results</strong> — Initials required
                </label>
            </div>

            <div class="initial-required">
                <input type="text" id="initial_sud" name="initial_sud" maxlength="3" placeholder="___">
                <label for="initial_sud">
                    <strong>Substance Use Disorder</strong> records (42 C.F.R. Part 2) — Initials required
                </label>
            </div>

            <div class="notice-box">
                <strong>NOTICE:</strong> Federal rules prohibit further disclosure of Part 2 records unless expressly
                permitted by your written consent or as otherwise allowed by Part 2.
            </div>

            <div class="initial-required">
                <input type="text" id="initial_mental" name="initial_mental" maxlength="3" placeholder="___">
                <label for="initial_mental">
                    <strong>Mental/behavioral health information</strong> (non-psychotherapy notes) — Initials required
                </label>
            </div>

            <div class="initial-required">
                <input type="text" id="initial_psychotherapy" name="initial_psychotherapy" maxlength="3" placeholder="___">
                <label for="initial_psychotherapy">
                    <strong>Psychotherapy notes</strong> (HIPAA-defined) — SEPARATE specific authorization required — Initials required
                </label>
            </div>
        </div>

        <!-- Section E: Acknowledgments -->
        <div class="form-section">
            <h3>E. Acknowledgments, Expiration, and Required HIPAA Statements</h3>

            <div class="acknowledgment-text">
                <strong>• Right of Access / Form & Format:</strong> I am requesting access and directing transmission of my records to Veritas One.
                Please provide the copy in the form and format requested if readily producible, otherwise in a readable alternative
                format agreed upon (45 C.F.R. §164.524(c)(2)). Please act as promptly as possible and no later than 30 days from
                receipt (one 30-day extension only with written notice). Fees must be reasonable and cost-based.
            </div>

            <div class="acknowledgment-text">
                <strong>• Voluntary/No Conditioning:</strong> My treatment, payment, enrollment, or eligibility for benefits will not be conditioned
                on signing this authorization (subject to HIPAA's limited exceptions).
            </div>

            <div class="acknowledgment-text">
                <strong>• Revocation:</strong> I may revoke this authorization at any time by written notice to Veritas One and to the Disclosing
                Provider, except to the extent action has been taken in reliance.
            </div>

            <div class="acknowledgment-text">
                <strong>• Redisclosure:</strong> Information disclosed to the recipient may be redisclosed and may no longer be protected by HIPAA,
                except as otherwise restricted by law (including 42 C.F.R. Part 2 for SUD records).
            </div>

            <div class="acknowledgment-text">
                <strong>• Minimum Necessary:</strong> Does not apply to disclosures to me or made pursuant to my authorization.
            </div>

            <div class="acknowledgment-text">
                <strong>• Expiration:</strong> This authorization expires <strong>6 months (180 days)</strong> from the date signed unless I specify
                an earlier date/event.
            </div>

            <div class="acknowledgment-text">
                <strong>• Outside Records:</strong> If the provider maintains outside records, those will not be released unless specifically
                requested.
            </div>
        </div>

        <!-- Signature Section -->
        <div class="signature-section">
            <h3>Patient Signature</h3>
            <p style="font-size: 12px; margin-bottom: 15px;">
                By signing below, I acknowledge that I have read and understand this authorization,
                and I voluntarily consent to the release of my medical records as specified above.
            </p>

            <div class="signature-canvas-container">
                <canvas id="sigpad" width="800" height="200"></canvas>
            </div>

            <div class="signature-controls">
                <button type="button" id="clear" class="btn-secondary">Clear Signature</button>
            </div>

            <div class="date-signed">
                Date: <strong id="current-date"></strong>
            </div>

            <input type="hidden" name="signature_data_url" id="signature_data_url">
            <input type="hidden" name="initial_hiv_value" id="initial_hiv_value">
            <input type="hidden" name="initial_genetic_value" id="initial_genetic_value">
            <input type="hidden" name="initial_sud_value" id="initial_sud_value">
            <input type="hidden" name="initial_mental_value" id="initial_mental_value">
            <input type="hidden" name="initial_psychotherapy_value" id="initial_psychotherapy_value">
        </div>

        <!-- Submit Section -->
        <div class="submit-section">
            <p style="font-size: 13px; margin-bottom: 15px; color: #666;">
                Please review all information above before submitting
            </p>
            <button type="submit" class="btn-submit" id="submit-btn">
                I Agree and Sign This Authorization
            </button>
        </div>
    </form>
</div>

<script>
// Set current date
document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
});

// Signature pad setup
const canvas = document.getElementById('sigpad');
const ctx = canvas.getContext('2d');
ctx.lineWidth = 2;
ctx.strokeStyle = '#000';
let drawing = false;
let hasSignature = false;

// Get canvas position
function getCanvasPos() {
    return canvas.getBoundingClientRect();
}

function getPos(e) {
    const rect = getCanvasPos();
    const touch = e.touches ? e.touches[0] : e;
    return {
        x: touch.clientX - rect.left,
        y: touch.clientY - rect.top
    };
}

canvas.addEventListener('pointerdown', (e) => {
    drawing = true;
    hasSignature = true;
    const pos = getPos(e);
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
});

canvas.addEventListener('pointermove', (e) => {
    if (!drawing) return;
    const pos = getPos(e);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
});

canvas.addEventListener('pointerup', () => {
    drawing = false;
});

canvas.addEventListener('pointerleave', () => {
    drawing = false;
});

// Touch events
canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
});

canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
});

// Clear button
document.getElementById('clear').onclick = () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    hasSignature = false;
};

// Form submission
function submitConsent() {
    // Validate signature
    if (!hasSignature) {
        alert('Please sign the authorization form before submitting.');
        return false;
    }

    // Capture signature
    document.getElementById('signature_data_url').value = canvas.toDataURL('image/png');

    // Capture initials
    document.getElementById('initial_hiv_value').value = document.getElementById('initial_hiv').value;
    document.getElementById('initial_genetic_value').value = document.getElementById('initial_genetic').value;
    document.getElementById('initial_sud_value').value = document.getElementById('initial_sud').value;
    document.getElementById('initial_mental_value').value = document.getElementById('initial_mental').value;
    document.getElementById('initial_psychotherapy_value').value = document.getElementById('initial_psychotherapy').value;

    // Disable submit button to prevent double submission
    document.getElementById('submit-btn').disabled = true;
    document.getElementById('submit-btn').textContent = 'Processing...';

    return true;
}
</script>
{% endblock %}