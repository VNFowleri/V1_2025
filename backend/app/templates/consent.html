{% extends "base.html" %}

{% block content %}
<style>
  .consent-container {
    max-width: 960px;
    margin: 0 auto;
  }
  
  .consent-card {
    background: white;
    border: 1px solid var(--border-light);
    border-radius: 16px;
    padding: 3rem;
    box-shadow: var(--shadow-xl);
    animation: fadeInUp 0.6s var(--ease-smooth);
  }
  
  .consent-header {
    text-align: center;
    padding-bottom: 2rem;
    border-bottom: 2px solid var(--navy-950);
    margin-bottom: 2.5rem;
  }
  
  .consent-eyebrow {
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--terra-600);
    margin-bottom: 0.75rem;
  }
  
  .consent-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--navy-950);
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: -0.01em;
  }
  
  .consent-subtitle {
    font-size: 1rem;
    color: var(--text-secondary);
    margin: 0;
  }
  
  .consent-section {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: var(--slate-50);
    border-left: 4px solid var(--navy-700);
    border-radius: 8px;
    animation: fadeInUp 0.6s var(--ease-smooth);
  }
  
  .consent-section:nth-child(1) { animation-delay: 0.1s; animation-fill-mode: both; }
  .consent-section:nth-child(2) { animation-delay: 0.2s; animation-fill-mode: both; }
  .consent-section:nth-child(3) { animation-delay: 0.3s; animation-fill-mode: both; }
  .consent-section:nth-child(4) { animation-delay: 0.4s; animation-fill-mode: both; }
  
  .section-title {
    font-size: 1rem;
    font-weight: 800;
    color: var(--navy-950);
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.02em;
    font-family: var(--font-body);
  }
  
  .patient-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
  
  .info-field {
    background: white;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-light);
    border-radius: 6px;
  }
  
  .info-label {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.25rem;
  }
  
  .info-value {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--navy-950);
    font-family: var(--font-mono);
  }
  
  .checkbox-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .checkbox-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.875rem;
    background: white;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s var(--ease-smooth);
  }
  
  .checkbox-item:hover {
    border-color: var(--navy-700);
    box-shadow: var(--shadow-sm);
  }
  
  .checkbox-item input[type="checkbox"] {
    margin-top: 2px;
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: var(--navy-900);
  }
  
  .checkbox-label {
    flex: 1;
    font-size: 0.875rem;
    line-height: 1.5;
    color: var(--text-primary);
    cursor: pointer;
  }
  
  .checkbox-label strong {
    font-weight: 700;
    color: var(--navy-950);
  }
  
  .sensitive-section {
    background: var(--terra-100);
    border-left-color: var(--terra-600);
  }
  
  .initials-grid {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .initials-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.875rem;
    background: white;
    border: 1px solid var(--terra-400);
    border-radius: 6px;
  }
  
  .initials-input {
    width: 80px;
    padding: 0.5rem 0.75rem;
    font-family: var(--font-mono);
    font-size: 0.875rem;
    font-weight: 600;
    text-align: center;
    text-transform: uppercase;
    border: 2px solid var(--terra-400);
    border-radius: 6px;
    background: white;
  }
  
  .initials-input:focus {
    border-color: var(--terra-600);
    box-shadow: 0 0 0 3px rgba(200, 104, 68, 0.1);
  }
  
  .initials-label {
    flex: 1;
    font-size: 0.875rem;
    line-height: 1.4;
    color: var(--text-primary);
  }
  
  .initials-label strong {
    font-weight: 700;
    color: var(--terra-600);
  }
  
  .notice-box {
    background: white;
    border: 1px solid var(--terra-400);
    border-radius: 6px;
    padding: 1rem;
    margin-top: 0.75rem;
    font-size: 0.8125rem;
    line-height: 1.5;
    color: var(--text-secondary);
  }
  
  .notice-box strong {
    color: var(--terra-600);
    font-weight: 700;
  }
  
  .acknowledgment-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .acknowledgment-item {
    padding: 1rem;
    background: white;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    font-size: 0.875rem;
    line-height: 1.6;
    color: var(--text-secondary);
  }
  
  .acknowledgment-item strong {
    font-weight: 700;
    color: var(--navy-950);
    display: block;
    margin-bottom: 0.25rem;
  }
  
  .signature-section {
    margin-top: 2.5rem;
    padding: 2rem;
    background: var(--slate-50);
    border: 2px dashed var(--navy-700);
    border-radius: 12px;
  }
  
  .signature-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--navy-950);
    margin-bottom: 1rem;
  }
  
  .signature-instruction {
    font-size: 0.9375rem;
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
  }
  
  .signature-canvas-wrapper {
    background: white;
    border: 2px solid var(--navy-700);
    border-radius: 8px;
    padding: 1rem;
    box-shadow: var(--shadow-md);
  }
  
  #sigpad {
    display: block;
    width: 100%;
    height: 180px;
    touch-action: none;
    cursor: crosshair;
    border-radius: 4px;
  }
  
  .signature-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
  }
  
  .signature-date {
    font-family: var(--font-mono);
    font-size: 0.875rem;
    color: var(--text-secondary);
  }
  
  .submit-section {
    margin-top: 2.5rem;
    padding: 2rem;
    background: var(--navy-950);
    border-radius: 12px;
    text-align: center;
  }
  
  .submit-instruction {
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 1.5rem;
  }
  
  .btn-submit {
    background: var(--terra-600);
    color: white;
    padding: 1rem 2.5rem;
    font-size: 1.0625rem;
    font-weight: 700;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: var(--shadow-lg);
    transition: all 0.25s var(--ease-smooth);
  }
  
  .btn-submit:hover:not(:disabled) {
    background: var(--terra-500);
    transform: translateY(-2px);
    box-shadow: var(--shadow-xl);
  }
  
  .btn-submit:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }
  
  @media (max-width: 768px) {
    .consent-card {
      padding: 2rem 1.5rem;
    }
    
    .patient-info-grid {
      grid-template-columns: 1fr;
    }
    
    .signature-controls {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start;
    }
  }
</style>

<div class="consent-container">
  <div class="consent-card">
    <div class="consent-header">
      <div class="consent-eyebrow">Step 2 of 4 — Legal Authorization</div>
      <h1 class="consent-title">Authorization for Release of Medical Information</h1>
      <p class="consent-subtitle">and Patient-Directed Access Request (Veritas One, Inc.)</p>
    </div>
    
    <form method="post" action="" onsubmit="return submitConsent()">
      <!-- Section A: Patient Information -->
      <div class="consent-section">
        <h3 class="section-title">A. Patient Information</h3>
        <div class="patient-info-grid">
          <div class="info-field">
            <div class="info-label">Patient Name</div>
            <div class="info-value">{{ patient.first_name }} {{ patient.last_name }}</div>
          </div>
          <div class="info-field">
            <div class="info-label">Date of Birth</div>
            <div class="info-value">{{ patient.date_of_birth if patient.date_of_birth else "Not provided" }}</div>
          </div>
          <div class="info-field">
            <div class="info-label">Phone Number</div>
            <div class="info-value">{{ patient.phone if patient.phone else "Not provided" }}</div>
          </div>
          <div class="info-field">
            <div class="info-label">Email Address</div>
            <div class="info-value">{{ patient.email if patient.email else "Not provided" }}</div>
          </div>
        </div>
      </div>
      
      <!-- Section B: Permission to Share -->
      <div class="consent-section">
        <h3 class="section-title">B. Permission to Share</h3>
        <div class="info-field" style="margin-bottom: 1rem;">
          <div class="info-label">Records FROM</div>
          <div class="info-value" style="font-family: var(--font-body); font-weight: 400; font-size: 0.875rem;">
            Healthcare providers you select in the next step
          </div>
        </div>
        <div class="info-field">
          <div class="info-label">Send Records TO</div>
          <div class="info-value" style="font-family: var(--font-body); font-weight: 600; font-size: 0.875rem;">
            Veritas One, Inc. — acting as your agent to receive, consolidate, and deliver records to you
          </div>
        </div>
      </div>
      
      <!-- Section C: Information to be Released -->
      <div class="consent-section">
        <h3 class="section-title">C. Information to be Released</h3>
        <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
          Check all categories that apply:
        </p>
        <div class="checkbox-list">
          <label class="checkbox-item">
            <input type="checkbox" id="all_records" name="records_all" checked>
            <span class="checkbox-label">
              <strong>ALL RECORDS (Designated Record Set), ALL DATES</strong><br>
              Includes clinical + billing; radiology reports & images
            </span>
          </label>
          
          <label class="checkbox-item">
            <input type="checkbox" id="medical_abstract" name="records_abstract">
            <span class="checkbox-label">
              Medical record abstract (H&P, operative reports, consults, test reports, discharge summaries)
            </span>
          </label>
          
          <label class="checkbox-item">
            <input type="checkbox" id="clinic_notes" name="records_clinic">
            <span class="checkbox-label">Clinic / visit notes</span>
          </label>
          
          <label class="checkbox-item">
            <input type="checkbox" id="lab" name="records_lab">
            <span class="checkbox-label">Laboratory results</span>
          </label>
          
          <label class="checkbox-item">
            <input type="checkbox" id="radiology" name="records_radiology">
            <span class="checkbox-label">Radiology REPORTS and IMAGES (DICOM/CD acceptable)</span>
          </label>
          
          <label class="checkbox-item">
            <input type="checkbox" id="billing" name="records_billing">
            <span class="checkbox-label">Billing / claims information</span>
          </label>
        </div>
      </div>
      
      <!-- Section D: Sensitive Information -->
      <div class="consent-section sensitive-section">
        <h3 class="section-title">D. Sensitive Information — Release Only If Initialed</h3>
        <p style="font-size: 0.875rem; color: var(--terra-600); font-weight: 600; margin-bottom: 1rem;">
          ⚠️ The following categories require your initials to be released:
        </p>
        
        <div class="initials-grid">
          <div class="initials-item">
            <input type="text" id="initial_hiv" name="initial_hiv" maxlength="3" placeholder="___" class="initials-input">
            <label for="initial_hiv" class="initials-label">
              <strong>HIV/AIDS</strong> testing, diagnosis, or treatment
            </label>
          </div>
          
          <div class="initials-item">
            <input type="text" id="initial_genetic" name="initial_genetic" maxlength="3" placeholder="___" class="initials-input">
            <label for="initial_genetic" class="initials-label">
              <strong>Genetic testing/results</strong>
            </label>
          </div>
          
          <div class="initials-item">
            <input type="text" id="initial_sud" name="initial_sud" maxlength="3" placeholder="___" class="initials-input">
            <label for="initial_sud" class="initials-label">
              <strong>Substance Use Disorder</strong> records (42 C.F.R. Part 2)
            </label>
          </div>
          
          <div class="notice-box">
            <strong>NOTICE:</strong> Federal rules prohibit further disclosure of Part 2 records unless expressly 
            permitted by your written consent or as otherwise allowed by Part 2.
          </div>
          
          <div class="initials-item">
            <input type="text" id="initial_mental" name="initial_mental" maxlength="3" placeholder="___" class="initials-input">
            <label for="initial_mental" class="initials-label">
              <strong>Mental/behavioral health information</strong> (non-psychotherapy notes)
            </label>
          </div>
          
          <div class="initials-item">
            <input type="text" id="initial_psychotherapy" name="initial_psychotherapy" maxlength="3" placeholder="___" class="initials-input">
            <label for="initial_psychotherapy" class="initials-label">
              <strong>Psychotherapy notes</strong> (HIPAA-defined) — SEPARATE specific authorization required
            </label>
          </div>
        </div>
      </div>
      
      <!-- Section E: Acknowledgments -->
      <div class="consent-section">
        <h3 class="section-title">E. Acknowledgments, Expiration, and Required HIPAA Statements</h3>
        <div class="acknowledgment-list">
          <div class="acknowledgment-item">
            <strong>• Right of Access / Form & Format:</strong>
            I am requesting access and directing transmission of my records to Veritas One. Please provide the copy in the form and format requested if readily producible, otherwise in a readable alternative format agreed upon (45 C.F.R. §164.524(c)(2)). Please act as promptly as possible and no later than 30 days from receipt (one 30-day extension only with written notice). Fees must be reasonable and cost-based.
          </div>
          
          <div class="acknowledgment-item">
            <strong>• Voluntary/No Conditioning:</strong>
            My treatment, payment, enrollment, or eligibility for benefits will not be conditioned on signing this authorization (subject to HIPAA's limited exceptions).
          </div>
          
          <div class="acknowledgment-item">
            <strong>• Revocation:</strong>
            I may revoke this authorization at any time by written notice to Veritas One and to the Disclosing Provider, except to the extent action has been taken in reliance.
          </div>
          
          <div class="acknowledgment-item">
            <strong>• Redisclosure:</strong>
            Information disclosed to the recipient may be redisclosed and may no longer be protected by HIPAA, except as otherwise restricted by law (including 42 C.F.R. Part 2 for SUD records).
          </div>
          
          <div class="acknowledgment-item">
            <strong>• Expiration:</strong>
            This authorization expires <strong>6 months (180 days)</strong> from the date signed unless I specify an earlier date/event.
          </div>
        </div>
      </div>
      
      <!-- Signature Section -->
      <div class="signature-section">
        <h3 class="signature-title">Patient Signature</h3>
        <p class="signature-instruction">
          By signing below, I acknowledge that I have read and understand this authorization, 
          and I voluntarily consent to the release of my medical records as specified above.
        </p>
        
        <div class="signature-canvas-wrapper">
          <canvas id="sigpad" width="800" height="180"></canvas>
        </div>
        
        <div class="signature-controls">
          <div class="signature-date">
            Date: <strong id="current-date"></strong>
          </div>
          <button type="button" id="clear" class="btn btn-ghost">Clear Signature</button>
        </div>
        
        <input type="hidden" name="signature_data_url" id="signature_data_url">
        <input type="hidden" name="initial_hiv_value" id="initial_hiv_value">
        <input type="hidden" name="initial_genetic_value" id="initial_genetic_value">
        <input type="hidden" name="initial_sud_value" id="initial_sud_value">
        <input type="hidden" name="initial_mental_value" id="initial_mental_value">
        <input type="hidden" name="initial_psychotherapy_value" id="initial_psychotherapy_value">
      </div>
      
      <!-- Submit Section -->
      <div class="submit-section">
        <p class="submit-instruction">
          Please review all information above before submitting
        </p>
        <button type="submit" class="btn-submit" id="submit-btn">
          I Agree and Sign This Authorization →
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// Set current date
document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Signature pad setup
const canvas = document.getElementById('sigpad');
const ctx = canvas.getContext('2d');
ctx.lineWidth = 2;
ctx.strokeStyle = '#0a1628';
ctx.lineCap = 'round';
ctx.lineJoin = 'round';

let drawing = false;
let hasSignature = false;

function getPos(e) {
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  const touch = e.touches ? e.touches[0] : e;
  return {
    x: (touch.clientX - rect.left) * scaleX,
    y: (touch.clientY - rect.top) * scaleY
  };
}

canvas.addEventListener('pointerdown', (e) => {
  drawing = true;
  hasSignature = true;
  const pos = getPos(e);
  ctx.beginPath();
  ctx.moveTo(pos.x, pos.y);
});

canvas.addEventListener('pointermove', (e) => {
  if (!drawing) return;
  const pos = getPos(e);
  ctx.lineTo(pos.x, pos.y);
  ctx.stroke();
});

canvas.addEventListener('pointerup', () => {
  drawing = false;
});

canvas.addEventListener('pointerleave', () => {
  drawing = false;
});

// Touch events
canvas.addEventListener('touchstart', (e) => {
  e.preventDefault();
});

canvas.addEventListener('touchmove', (e) => {
  e.preventDefault();
});

// Clear button
document.getElementById('clear').onclick = () => {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  hasSignature = false;
};

// Auto-uppercase initials inputs
document.querySelectorAll('.initials-input').forEach(input => {
  input.addEventListener('input', (e) => {
    e.target.value = e.target.value.toUpperCase();
  });
});

// Form submission
function submitConsent() {
  // Validate signature
  if (!hasSignature) {
    alert('Please sign the authorization form before submitting.');
    return false;
  }
  
  // Capture signature
  document.getElementById('signature_data_url').value = canvas.toDataURL('image/png');
  
  // Capture initials
  document.getElementById('initial_hiv_value').value = document.getElementById('initial_hiv').value;
  document.getElementById('initial_genetic_value').value = document.getElementById('initial_genetic').value;
  document.getElementById('initial_sud_value').value = document.getElementById('initial_sud').value;
  document.getElementById('initial_mental_value').value = document.getElementById('initial_mental').value;
  document.getElementById('initial_psychotherapy_value').value = document.getElementById('initial_psychotherapy').value;
  
  // Disable submit button
  const submitBtn = document.getElementById('submit-btn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Processing...';
  
  return true;
}
</script>

{% endblock %}
