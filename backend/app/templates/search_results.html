{% extends "base.html" %}

{% block title %}Select Providers - Veritas One{% endblock %}

{% block content %}
<section class="section" style="background: var(--cream);">
  <div class="container">
    <!-- Progress Steps -->
    <div class="steps-container">
      <div class="step completed">
        <div class="step-number">1</div>
        <div class="step-label">Create Account</div>
      </div>
      <div class="step completed">
        <div class="step-number">2</div>
        <div class="step-label">Sign Consent</div>
      </div>
      <div class="step active">
        <div class="step-number">3</div>
        <div class="step-label">Find Providers</div>
      </div>
      <div class="step">
        <div class="step-number">4</div>
        <div class="step-label">Get Records</div>
      </div>
    </div>

    <div style="max-width: 1000px; margin: 0 auto;">
      <div class="card" style="margin-bottom: var(--space-lg);">
        <div class="card-header">
          <h2 class="card-title" style="margin: 0;">Search Results</h2>
        </div>
        <div class="card-body">
          <p style="margin: 0;">
            Found <strong>{{ hospitals|length }}</strong> healthcare provider(s) matching your search.
            Select the ones where you've received care.
          </p>
        </div>
      </div>

      {% if hospitals %}
      <div style="display: grid; gap: var(--space-md);">
        {% for hospital in hospitals %}
        <div class="provider-card" data-provider="{{ hospital|tojson|escape }}">
          <div class="provider-checkbox">
            <input
              type="checkbox"
              id="provider_{{ loop.index }}"
              class="provider-select"
              data-provider-json="{{ hospital|tojson|escape }}"
            >
          </div>
          <div class="provider-info">
            <div class="provider-header">
              <label for="provider_{{ loop.index }}" style="cursor: pointer; flex: 1;">
                <h3 class="provider-name">{{ hospital.name }}</h3>
              </label>
              <div class="provider-badges">
                {% if hospital.source %}
                <span class="badge badge-info text-mono" style="font-size: 0.7rem;">{{ hospital.source }}</span>
                {% endif %}
                {% if hospital.fax_verified %}
                <span class="badge badge-success">‚úì Fax Verified</span>
                {% endif %}
              </div>
            </div>

            <div class="provider-details">
              {% if hospital.address %}
              <div class="detail-item">
                <span class="detail-icon">üìç</span>
                <span>{{ hospital.address }}</span>
              </div>
              {% endif %}

              {% if hospital.fax %}
              <div class="detail-item">
                <span class="detail-icon">üì†</span>
                <span class="text-mono">{{ hospital.fax }}</span>
                {% if hospital.fax_confidence %}
                <span class="badge badge-neutral" style="margin-left: 0.5rem; font-size: 0.7rem;">
                  {{ (hospital.fax_confidence * 100)|round }}% confidence
                </span>
                {% endif %}
              </div>
              {% else %}
              <div class="detail-item" style="color: var(--terracotta);">
                <span class="detail-icon">‚ö†Ô∏è</span>
                <span>No fax number available - you can add one manually in the next step</span>
              </div>
              {% endif %}

              {% if hospital.phone %}
              <div class="detail-item">
                <span class="detail-icon">üìû</span>
                <span class="text-mono">{{ hospital.phone }}</span>
              </div>
              {% endif %}

              {% if hospital.npi %}
              <div class="detail-item">
                <span class="detail-icon">üè•</span>
                <span class="text-small text-mono">NPI: {{ hospital.npi }}</span>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <div style="margin-top: var(--space-xl); display: flex; gap: var(--space-md); justify-content: space-between; align-items: center;">
        <a href="/search-providers/{{ patient.id }}" class="btn btn-ghost">
          ‚Üê Back to Search
        </a>

        <button
          id="continue-btn"
          class="btn btn-primary"
          onclick="continueToReview()"
          disabled
        >
          Continue to Review (<span id="selected-count">0</span>)
        </button>
      </div>

      {% else %}
      <div class="card" style="background: rgba(199, 101, 72, 0.08); border-color: var(--terracotta); text-align: center; padding: var(--space-xl);">
        <h3 style="color: var(--terracotta); margin-bottom: var(--space-md);">No Results Found</h3>
        <p style="margin-bottom: var(--space-lg);">
          We couldn't find any providers matching your search. Try a different search term or location.
        </p>
        <a href="/search-providers/{{ patient.id }}" class="btn btn-primary">
          ‚Üê Try a Different Search
        </a>
      </div>
      {% endif %}
    </div>
  </div>
</section>

<style>
.provider-card {
  display: flex;
  gap: var(--space-md);
  padding: var(--space-lg);
  background: white;
  border: 2px solid var(--cream-dark);
  border-radius: 12px;
  transition: all var(--transition-base);
  opacity: 0;
  animation: fadeInUp 0.4s ease forwards;
}

.provider-card:nth-child(1) { animation-delay: 0.05s; }
.provider-card:nth-child(2) { animation-delay: 0.1s; }
.provider-card:nth-child(3) { animation-delay: 0.15s; }
.provider-card:nth-child(4) { animation-delay: 0.2s; }
.provider-card:nth-child(5) { animation-delay: 0.25s; }

.provider-card:hover {
  border-color: var(--burgundy);
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
}

.provider-card.selected {
  border-color: var(--forest);
  background: rgba(44, 95, 79, 0.04);
}

.provider-checkbox {
  display: flex;
  align-items: flex-start;
  padding-top: 2px;
}

.provider-checkbox input[type="checkbox"] {
  width: 24px;
  height: 24px;
  cursor: pointer;
  accent-color: var(--forest);
}

.provider-info {
  flex: 1;
}

.provider-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: var(--space-md);
  margin-bottom: var(--space-sm);
}

.provider-name {
  font-family: var(--font-display);
  font-size: 1.35rem;
  font-weight: 700;
  color: var(--burgundy-dark);
  margin: 0;
  line-height: 1.3;
}

.provider-badges {
  display: flex;
  gap: var(--space-xs);
  flex-wrap: wrap;
}

.provider-details {
  display: grid;
  gap: var(--space-xs);
}

.detail-item {
  display: flex;
  align-items: center;
  gap: var(--space-xs);
  font-size: 0.95rem;
  color: var(--slate);
}

.detail-icon {
  font-size: 1rem;
}

#continue-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
</style>

<script>
let selectedProviders = [];

// Load previously selected providers from sessionStorage
window.addEventListener('DOMContentLoaded', function() {
  const saved = sessionStorage.getItem('selectedProviders');
  if (saved) {
    try {
      selectedProviders = JSON.parse(saved);
      // Check the boxes for saved providers
      document.querySelectorAll('.provider-select').forEach(checkbox => {
        const data = JSON.parse(checkbox.dataset.providerJson);
        if (selectedProviders.some(p => p.npi === data.npi || p.name === data.name)) {
          checkbox.checked = true;
          checkbox.closest('.provider-card').classList.add('selected');
        }
      });
      updateCount();
    } catch (e) {
      console.error('Error loading saved providers:', e);
    }
  }
});

// Handle checkbox changes
document.querySelectorAll('.provider-select').forEach(checkbox => {
  checkbox.addEventListener('change', function() {
    const card = this.closest('.provider-card');
    const providerData = JSON.parse(this.dataset.providerJson);

    if (this.checked) {
      card.classList.add('selected');
      // Add to selection if not already there
      if (!selectedProviders.some(p => p.npi === providerData.npi || p.name === providerData.name)) {
        selectedProviders.push(providerData);
      }
    } else {
      card.classList.remove('selected');
      // Remove from selection
      selectedProviders = selectedProviders.filter(p =>
        p.npi !== providerData.npi && p.name !== providerData.name
      );
    }

    updateCount();
    saveToSession();
  });
});

function updateCount() {
  const count = selectedProviders.length;
  document.getElementById('selected-count').textContent = count;
  document.getElementById('continue-btn').disabled = count === 0;
}

function saveToSession() {
  sessionStorage.setItem('selectedProviders', JSON.stringify(selectedProviders));
}

function continueToReview() {
  // Save selected providers to sessionStorage
  saveToSession();
  // Navigate to review page
  window.location.href = '/review-providers/{{ patient.id }}';
}
</script>
{% endblock %}