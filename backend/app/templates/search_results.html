<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Search Results - Veritas One</title>
  <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
<section class="container">
  <h1>Search Results</h1>

  <div class="search-info">
    {% if search_query %}
    <p><strong>Search query:</strong> {{ search_query }}</p>
    {% endif %}
    {% if city %}
    <p><strong>Location:</strong> {{ city }}{% if state %}, {{ state }}{% endif %}{% if zip_code %} {{ zip_code }}{% endif %}</p>
    {% endif %}
    <p><strong>Results:</strong> {{ hospitals|length }} provider(s) found</p>
  </div>

  {% if hospitals %}
    <div class="search-actions">
      <button type="button" onclick="selectAll()" class="btn btn-secondary">Select All</button>
      <button type="button" onclick="selectVerified()" class="btn btn-secondary">Select Verified Only</button>
      <button type="button" onclick="deselectAll()" class="btn btn-secondary">Deselect All</button>
    </div>

    <div id="resultsContainer">
      {% for hospital in hospitals %}
      <div class="result-card {% if hospital.fax_verified %}verified{% endif %}" id="card_{{ loop.index0 }}">
        <input
          type="checkbox"
          class="provider-checkbox"
          id="hospital_{{ loop.index0 }}"
          data-provider='{{ hospital | tojson }}'
          onchange="updateSelectionCount()"
        >
        <label for="hospital_{{ loop.index0 }}" class="result-label">
          <div class="result-header">
            <h3>{{ hospital.name }}</h3>
            <div class="badges">
              {% if hospital.source %}
              <span class="source-badge">{{ hospital.source }}</span>
              {% endif %}
              {% if hospital.fax_verified %}
              <span class="verified-badge">✓ HAS FAX</span>
              {% endif %}
            </div>
          </div>

          <div class="result-details">
            {% if hospital.address %}
            <p><strong>Address:</strong> {{ hospital.address }}</p>
            {% endif %}

            {% if hospital.phone %}
            <p><strong>Phone:</strong> {{ hospital.phone }}</p>
            {% endif %}

            {% if hospital.npi %}
            <p><strong>NPI:</strong> {{ hospital.npi }}</p>
            {% endif %}

            {% if hospital.fax or hospital.medical_records_fax %}
            <div class="fax-info">
              <p class="fax-number">
                <strong>Fax:</strong> {{ hospital.medical_records_fax or hospital.fax }}
              </p>
              {% if hospital.fax_confidence %}
              <p class="fax-source">
                Confidence: {{ (hospital.fax_confidence * 100) | round | int }}%
                {% if hospital.fax_verification_source %}
                (Source: {{ hospital.fax_verification_source }})
                {% endif %}
              </p>
              {% endif %}
            </div>
            {% else %}
            <div class="fax-warning">
              <p><strong>⚠️ No fax number available</strong></p>
              <p class="fax-note">You can add it manually on the next screen</p>
            </div>
            {% endif %}
          </div>
        </label>
      </div>
      {% endfor %}
    </div>

    <div class="selection-summary">
      <p><strong>Selected Providers: <span id="selectedCount">0</span></strong></p>
    </div>

    <div class="form-actions">
      <a href="/search-providers/{{ patient.id }}" class="btn btn-secondary">New Search</a>
      <button
        type="button"
        onclick="continueToReview()"
        class="btn btn-primary"
        id="continueBtn"
        disabled
      >
        CONTINUE TO REVIEW →
      </button>
    </div>

  {% else %}
    <div class="no-results">
      <p>No providers found matching your search.</p>
      <p><strong>Try:</strong></p>
      <ul>
        <li>Searching with different terms</li>
        <li>Using a broader location (city or state only)</li>
        <li><a href="/review-providers/{{ patient.id }}">Adding providers manually</a></li>
      </ul>
    </div>

    <div class="form-actions">
      <a href="/search-providers/{{ patient.id }}" class="btn btn-secondary">New Search</a>
      <a href="/review-providers/{{ patient.id }}" class="btn btn-primary">Add Manually</a>
    </div>
  {% endif %}
</section>

<script>
// Track selected providers globally
let selectedProviders = [];

// Update selection count and button state
function updateSelectionCount() {
  const checkboxes = document.querySelectorAll('.provider-checkbox:checked');
  const count = checkboxes.length;
  const countElement = document.getElementById('selectedCount');
  const continueBtn = document.getElementById('continueBtn');

  if (countElement) {
    countElement.textContent = count;
  }

  if (continueBtn) {
    continueBtn.disabled = count === 0;
  }

  console.log(`Selection updated: ${count} provider(s) selected`);
}

// Select all checkboxes
function selectAll() {
  document.querySelectorAll('.provider-checkbox').forEach(cb => {
    cb.checked = true;
  });
  updateSelectionCount();
}

// Select only verified providers
function selectVerified() {
  document.querySelectorAll('.provider-checkbox').forEach(cb => {
    const card = cb.closest('.result-card');
    cb.checked = card && card.classList.contains('verified');
  });
  updateSelectionCount();
}

// Deselect all checkboxes
function deselectAll() {
  document.querySelectorAll('.provider-checkbox').forEach(cb => {
    cb.checked = false;
  });
  updateSelectionCount();
}

// Continue to review page
function continueToReview() {
  selectedProviders = [];

  // Collect all checked providers
  document.querySelectorAll('.provider-checkbox:checked').forEach(cb => {
    try {
      const providerData = JSON.parse(cb.getAttribute('data-provider'));
      selectedProviders.push(providerData);
    } catch (e) {
      console.error('Error parsing provider data:', e);
    }
  });

  console.log(`Selected ${selectedProviders.length} provider(s)`);

  if (selectedProviders.length === 0) {
    alert('Please select at least one provider to continue');
    return;
  }

  // Store in sessionStorage
  try {
    sessionStorage.setItem('selectedProviders', JSON.stringify(selectedProviders));
    console.log('Providers saved to sessionStorage');
  } catch (e) {
    console.error('Error saving to sessionStorage:', e);
    alert('Error saving selection. Please try again.');
    return;
  }

  // Redirect to review page
  const patientId = '{{ patient.id }}';
  const reviewUrl = `/review-providers/${patientId}`;
  console.log(`Redirecting to: ${reviewUrl}`);

  window.location.href = reviewUrl;
}

// Initialize on page load
window.addEventListener('DOMContentLoaded', function() {
  console.log('Search results page loaded');
  const checkboxes = document.querySelectorAll('.provider-checkbox');
  console.log(`Found ${checkboxes.length} provider checkboxes`);

  // Initialize count
  updateSelectionCount();
});
</script>

<style>
.search-info {
  background: #e7f3ff;
  border-left: 4px solid #007bff;
  padding: 1rem;
  margin: 1rem 0;
  border-radius: 4px;
}

.search-info p {
  margin: 0.25rem 0;
}

.search-actions {
  display: flex;
  gap: 0.5rem;
  margin: 1rem 0;
  flex-wrap: wrap;
}

.result-card {
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 1rem;
  margin: 1rem 0;
  display: flex;
  gap: 1rem;
  background: white;
  transition: all 0.2s;
}

.result-card.verified {
  border-color: #28a745;
  background: #f8fff9;
}

.result-card:has(.provider-checkbox:checked) {
  border-color: #007bff;
  background-color: #f0f8ff;
  box-shadow: 0 2px 8px rgba(0,123,255,0.2);
}

.provider-checkbox {
  width: 20px;
  height: 20px;
  cursor: pointer;
  flex-shrink: 0;
  margin-top: 0.25rem;
}

.result-label {
  flex: 1;
  cursor: pointer;
}

.result-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 0.5rem;
  gap: 1rem;
}

.result-header h3 {
  margin: 0;
  font-size: 1.1rem;
  flex: 1;
}

.badges {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.source-badge {
  background: #6c757d;
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 500;
  white-space: nowrap;
}

.verified-badge {
  background: #28a745;
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 500;
  white-space: nowrap;
}

.result-details p {
  margin: 0.25rem 0;
  font-size: 0.9rem;
}

.fax-info {
  background: #f8f9fa;
  padding: 0.75rem;
  border-radius: 4px;
  margin: 0.5rem 0;
}

.fax-number {
  color: #28a745;
  font-weight: bold;
  font-family: monospace;
  margin: 0;
}

.fax-source {
  font-size: 0.85rem;
  color: #666;
  margin: 0.25rem 0 0 0;
}

.fax-warning {
  background: #fff3cd;
  border-left: 3px solid #ffc107;
  padding: 0.75rem;
  border-radius: 4px;
  margin: 0.5rem 0;
}

.fax-warning p {
  margin: 0.25rem 0;
  color: #856404;
}

.fax-note {
  font-size: 0.85rem;
  font-style: italic;
}

.selection-summary {
  background: #f8f9fa;
  border: 2px solid #007bff;
  border-radius: 8px;
  padding: 1rem;
  margin: 1.5rem 0;
  text-align: center;
}

.selection-summary p {
  margin: 0;
  font-size: 1.1rem;
}

#selectedCount {
  color: #007bff;
  font-size: 1.3rem;
}

.no-results {
  background: #f8f9fa;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 2rem;
  text-align: center;
  margin: 2rem 0;
}

.no-results ul {
  text-align: left;
  display: inline-block;
  margin-top: 1rem;
}

.form-actions {
  display: flex;
  gap: 1rem;
  justify-content: center;
  margin: 2rem 0;
}

.btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 6px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  text-decoration: none;
  display: inline-block;
  text-align: center;
  transition: all 0.2s;
}

.btn-primary {
  background: #007bff;
  color: white;
}

.btn-primary:hover:not(:disabled) {
  background: #0056b3;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,123,255,0.3);
}

.btn-primary:disabled {
  background: #ccc;
  cursor: not-allowed;
  opacity: 0.6;
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-secondary:hover {
  background: #545b62;
}

@media (max-width: 768px) {
  .result-card {
    flex-direction: column;
  }

  .search-actions {
    flex-direction: column;
  }

  .form-actions {
    flex-direction: column;
  }

  .btn {
    width: 100%;
  }
}
</style>
</body>
</html>