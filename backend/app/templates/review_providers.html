<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Review Providers - Veritas One</title>
  <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
<section class="container">
  <h1>Review Selected Providers</h1>

  <p class="instructions">
    Review the providers below. You can edit fax numbers or add additional providers manually.
  </p>

  <div id="providersContainer">
    <!-- Providers will be loaded here by JavaScript -->
  </div>

  <div class="manual-provider-section">
    <h3>Add Provider Manually</h3>
    <div class="manual-form">
      <div class="form-row">
        <label class="form-col">
          Provider Name *
          <input type="text" id="manualName" placeholder="e.g., Massachusetts General Hospital" required>
        </label>
        <label class="form-col">
          Fax Number *
          <input type="tel" id="manualFax" placeholder="e.g., +1-555-123-4567" required>
        </label>
      </div>
      <div class="form-row">
        <label class="form-col">
          Address (optional)
          <input type="text" id="manualAddress" placeholder="e.g., 123 Main St, Boston, MA 02115">
        </label>
        <label class="form-col">
          Phone (optional)
          <input type="tel" id="manualPhone" placeholder="e.g., +1-555-123-4567">
        </label>
      </div>
      <button type="button" onclick="addManualProvider()" class="btn btn-secondary">
        + Add Provider
      </button>
    </div>
  </div>

  <div class="review-summary" id="summary">
    <h3>Summary</h3>
    <p>You will send medical record requests to <strong><span id="providerCount">0</span> provider(s)</strong>.</p>
    <p class="summary-note">Each provider will receive a fax with your signed HIPAA authorization.</p>
  </div>

  <form method="post" action="/review-providers/{{ patient.id }}" id="finalForm">
    <input type="hidden" name="selected_providers" id="selectedProvidersInput">

    <div class="form-actions">
      <a href="/search-providers/{{ patient.id }}" class="btn btn-secondary">← Back to Search</a>
      <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
        Send Requests
      </button>
    </div>
  </form>

  <div class="important-note">
    <h4>⚠️ Important</h4>
    <p>By clicking "Send Requests", you authorize us to send fax requests to all selected providers on your behalf using your signed HIPAA authorization.</p>
  </div>
</section>

<script>
let providers = [];

// Load providers from sessionStorage on page load
window.addEventListener('DOMContentLoaded', function() {
  console.log('Review providers page loaded');

  const stored = sessionStorage.getItem('selectedProviders');
  console.log('SessionStorage data:', stored);

  if (stored) {
    try {
      providers = JSON.parse(stored);
      console.log(`Loaded ${providers.length} providers from sessionStorage`);
      renderProviders();
    } catch (e) {
      console.error('Error parsing stored providers:', e);
      providers = [];
    }
  } else {
    console.log('No providers found in sessionStorage');
  }

  updateSummary();
});

// Render providers in the container
function renderProviders() {
  const container = document.getElementById('providersContainer');

  if (providers.length === 0) {
    container.innerHTML = '<div class="no-providers"><p>No providers selected yet. <a href="/search-providers/{{ patient.id }}">Search for providers</a> or add them manually below.</p></div>';
    return;
  }

  container.innerHTML = '<h3>Selected Providers</h3>';

  providers.forEach((provider, index) => {
    const card = document.createElement('div');
    card.className = 'provider-card';
    card.id = `provider_${index}`;

    const hasFax = provider.fax || provider.medical_records_fax;
    const faxNumber = provider.medical_records_fax || provider.fax || '';

    card.innerHTML = `
      <div class="provider-info">
        <div class="provider-header">
          <h4>${provider.name}</h4>
          ${provider.fax_verified ? '<span class="verified-badge">✓ Verified</span>' : ''}
          ${provider.source ? `<span class="source-badge">${provider.source}</span>` : ''}
        </div>

        ${provider.address ? `<p><strong>Address:</strong> ${provider.address}</p>` : ''}
        ${provider.phone ? `<p><strong>Phone:</strong> ${provider.phone}</p>` : ''}
        ${provider.npi ? `<p class="npi"><strong>NPI:</strong> ${provider.npi}</p>` : ''}

        <div class="fax-input-group ${hasFax ? '' : 'missing'}">
          <label for="fax_${index}"><strong>Fax Number:</strong></label>
          <input
            type="tel"
            id="fax_${index}"
            value="${faxNumber}"
            onchange="updateProviderFax(${index}, this.value)"
            placeholder="Enter fax number (required)"
            class="fax-input ${hasFax ? '' : 'required'}"
            required
          >
          ${!hasFax ? '<p class="fax-warning">⚠️ Fax number required</p>' : ''}
        </div>
      </div>

      <button type="button" onclick="removeProvider(${index})" class="btn-remove" title="Remove provider">
        ✕
      </button>
    `;

    container.appendChild(card);
  });
}

// Update provider fax number
function updateProviderFax(index, newFax) {
  if (providers[index]) {
    providers[index].fax = newFax;
    console.log(`Updated fax for ${providers[index].name}: ${newFax}`);
    updateSummary();
  }
}

// Remove a provider
function removeProvider(index) {
  const provider = providers[index];
  if (confirm(`Remove ${provider.name} from your request?`)) {
    providers.splice(index, 1);
    console.log(`Removed provider, ${providers.length} remaining`);
    renderProviders();
    updateSummary();

    // Update sessionStorage
    sessionStorage.setItem('selectedProviders', JSON.stringify(providers));
  }
}

// Add manual provider
function addManualProvider() {
  const name = document.getElementById('manualName').value.trim();
  const fax = document.getElementById('manualFax').value.trim();
  const address = document.getElementById('manualAddress').value.trim();
  const phone = document.getElementById('manualPhone').value.trim();

  if (!name || !fax) {
    alert('Provider name and fax number are required');
    return;
  }

  // Check for duplicates
  const duplicate = providers.find(p =>
    p.name.toLowerCase() === name.toLowerCase() &&
    p.fax === fax
  );

  if (duplicate) {
    alert('This provider is already in your list');
    return;
  }

  const newProvider = {
    name: name,
    fax: fax,
    address: address || null,
    phone: phone || null,
    source: 'manual',
    fax_verified: false
  };

  providers.push(newProvider);
  console.log(`Added manual provider: ${name}`);

  // Clear form
  document.getElementById('manualName').value = '';
  document.getElementById('manualFax').value = '';
  document.getElementById('manualAddress').value = '';
  document.getElementById('manualPhone').value = '';

  // Update display
  renderProviders();
  updateSummary();

  // Update sessionStorage
  sessionStorage.setItem('selectedProviders', JSON.stringify(providers));
}

// Update summary and enable/disable submit button
function updateSummary() {
  const count = providers.length;
  const countElement = document.getElementById('providerCount');
  const submitBtn = document.getElementById('submitBtn');
  const formInput = document.getElementById('selectedProvidersInput');

  if (countElement) {
    countElement.textContent = count;
  }

  // Check if all providers have fax numbers
  const allHaveFax = providers.every(p => p.fax || p.medical_records_fax);
  const canSubmit = count > 0 && allHaveFax;

  if (submitBtn) {
    submitBtn.disabled = !canSubmit;

    if (count === 0) {
      submitBtn.title = 'Add at least one provider';
    } else if (!allHaveFax) {
      submitBtn.title = 'All providers must have fax numbers';
    } else {
      submitBtn.title = 'Send requests to all providers';
    }
  }

  // Update hidden form input
  if (formInput) {
    formInput.value = JSON.stringify(providers);
  }

  console.log(`Summary updated: ${count} providers, can submit: ${canSubmit}`);
}

// Handle form submission
document.getElementById('finalForm').addEventListener('submit', function(e) {
  e.preventDefault();

  if (providers.length === 0) {
    alert('Please add at least one provider');
    return;
  }

  const missingFax = providers.filter(p => !p.fax && !p.medical_records_fax);
  if (missingFax.length > 0) {
    alert(`${missingFax.length} provider(s) are missing fax numbers. Please add fax numbers for all providers.`);
    return;
  }

  console.log('Submitting form with providers:', providers);

  // Update hidden input
  document.getElementById('selectedProvidersInput').value = JSON.stringify(providers);

  // Submit the form
  this.submit();
});
</script>

<style>
.instructions {
  background: #e7f3ff;
  border-left: 4px solid #007bff;
  padding: 1rem;
  margin: 1rem 0;
  border-radius: 4px;
}

.provider-card {
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 1.5rem;
  margin: 1rem 0;
  background: white;
  display: flex;
  justify-content: space-between;
  gap: 1rem;
  transition: all 0.2s;
}

.provider-card:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.provider-info {
  flex: 1;
}

.provider-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  flex-wrap: wrap;
}

.provider-header h4 {
  margin: 0;
  font-size: 1.1rem;
  flex: 1;
}

.verified-badge {
  background: #28a745;
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 500;
}

.source-badge {
  background: #6c757d;
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 500;
}

.provider-info p {
  margin: 0.5rem 0;
  font-size: 0.9rem;
}

.npi {
  font-family: monospace;
  color: #666;
}

.fax-input-group {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid #eee;
}

.fax-input-group.missing {
  background: #fff3cd;
  padding: 1rem;
  border-radius: 4px;
  border-top: none;
}

.fax-input {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 1rem;
  margin-top: 0.25rem;
}

.fax-input.required {
  border-color: #ffc107;
}

.fax-input:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0,123,255,0.1);
}

.fax-warning {
  color: #856404;
  font-size: 0.85rem;
  margin: 0.25rem 0 0 0;
  font-style: italic;
}

.btn-remove {
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  cursor: pointer;
  font-size: 1.2rem;
  line-height: 1;
  transition: all 0.2s;
  flex-shrink: 0;
}

.btn-remove:hover {
  background: #c82333;
  transform: scale(1.1);
}

.manual-provider-section {
  background: #f8f9fa;
  border: 2px dashed #ddd;
  border-radius: 8px;
  padding: 1.5rem;
  margin: 2rem 0;
}

.manual-provider-section h3 {
  margin-top: 0;
}

.manual-form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.form-col {
  display: flex;
  flex-direction: column;
}

.form-col input {
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 1rem;
  margin-top: 0.25rem;
}

.form-col input:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0,123,255,0.1);
}

.review-summary {
  background: #e7f3ff;
  border-left: 4px solid #007bff;
  padding: 1.5rem;
  margin: 2rem 0;
  border-radius: 4px;
}

.review-summary h3 {
  margin-top: 0;
}

.review-summary p {
  margin: 0.5rem 0;
}

.summary-note {
  font-size: 0.9rem;
  color: #666;
  font-style: italic;
}

#providerCount {
  color: #007bff;
  font-size: 1.2rem;
}

.no-providers {
  background: #f8f9fa;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 2rem;
  text-align: center;
  margin: 2rem 0;
}

.important-note {
  background: #fff3cd;
  border-left: 4px solid #ffc107;
  padding: 1rem;
  margin: 2rem 0;
  border-radius: 4px;
}

.important-note h4 {
  margin-top: 0;
  color: #856404;
}

.important-note p {
  margin: 0.5rem 0 0 0;
  color: #856404;
}

.form-actions {
  display: flex;
  gap: 1rem;
  justify-content: center;
  margin: 2rem 0;
}

.btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 6px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  text-decoration: none;
  display: inline-block;
  text-align: center;
  transition: all 0.2s;
}

.btn-primary {
  background: #007bff;
  color: white;
}

.btn-primary:hover:not(:disabled) {
  background: #0056b3;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,123,255,0.3);
}

.btn-primary:disabled {
  background: #ccc;
  cursor: not-allowed;
  opacity: 0.6;
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-secondary:hover {
  background: #545b62;
}

@media (max-width: 768px) {
  .form-row {
    grid-template-columns: 1fr;
  }

  .provider-card {
    flex-direction: column;
  }

  .btn-remove {
    align-self: flex-end;
  }

  .form-actions {
    flex-direction: column;
  }

  .btn {
    width: 100%;
  }
}
</style>
</body>
</html>