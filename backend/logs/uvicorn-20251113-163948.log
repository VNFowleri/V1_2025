[32mINFO[0m:     Will watch for changes in these directories: ['/Users/brandongaston/Library/Mobile Documents/com~apple~CloudDocs/PycharmProjects/Veritas_One_2025/backend']
[32mINFO[0m:     Uvicorn running on [1mhttp://127.0.0.1:8000[0m (Press CTRL+C to quit)
[32mINFO[0m:     Started reloader process [[36m[1m5169[0m] using [36m[1mWatchFiles[0m
[32mINFO[0m:     Started server process [[36m5172[0m]
[32mINFO[0m:     Waiting for application startup.
[32mINFO[0m:     Application startup complete.
[32mINFO[0m:     127.0.0.1:50568 - "[1mGET / HTTP/1.1[0m" [33m303 See Other[0m
[32mINFO[0m:     127.0.0.1:50569 - "[1mGET /portal/3842f649-fcc0-43ac-98fe-087392ba67ff HTTP/1.1[0m" [32m200 OK[0m
[32mINFO[0m:     127.0.0.1:50568 - "[1mGET /static/css/styles.css HTTP/1.1[0m" [33m304 Not Modified[0m
[32mINFO[0m:     127.0.0.1:50582 - "[1mGET / HTTP/1.1[0m" [33m303 See Other[0m
[32mINFO[0m:     127.0.0.1:50581 - "[1mGET /portal/3842f649-fcc0-43ac-98fe-087392ba67ff HTTP/1.1[0m" [32m200 OK[0m
[32mINFO[0m:     127.0.0.1:50581 - "[1mGET /search-providers/14 HTTP/1.1[0m" [32m200 OK[0m
[32mINFO[0m:     127.0.0.1:50584 - "[1mPOST /search-providers/14 HTTP/1.1[0m" [32m200 OK[0m
[32mINFO[0m:     127.0.0.1:50586 - "[1mGET /review-providers/14 HTTP/1.1[0m" [32m200 OK[0m
INFO:app.services.ifax_service:Sending fax to: +1-938-336-4787 (formatted: +19383364787)
INFO:app.services.ifax_service:Added file to fax: cover_rr9_prov35.pdf (5396 chars)
INFO:app.services.ifax_service:Added file to fax: release_patient_14.pdf (2704 chars)
INFO:app.services.ifax_service:Webhook configured: https://veritasone.net/ifax/outbound-status
INFO:app.services.ifax_service:Sending fax request: {'faxNumber': '+19383364787', 'files': [{'name': 'cover_rr9_prov35.pdf', 'size': 5396}, {'name': 'release_patient_14.pdf', 'size': 2704}], 'coverPage': {'text': 'Medical Records Request for John Smith'}, 'webhook': {'statusUrl': 'https://veritasone.net/ifax/outbound-status'}}
INFO:app.services.ifax_service:iFax API response: 200
INFO:app.services.ifax_service:iFax API response data: {'status': 0, 'code': 12005, 'message': 'Not enough credits'}
ERROR:app.services.ifax_service:‚ùå Fax send failed: Not enough credits
ERROR:app.services.ifax_service:Full response: {'status': 0, 'code': 12005, 'message': 'Not enough credits'}
ERROR:app.routers.web:‚ùå Failed to send fax to test clinic (Fax: +1-938-336-4787): Not enough credits
INFO:app.routers.web:‚úÖ Record request 9 created with 1 providers. Faxes sent with professional cover sheets and release forms.
[32mINFO[0m:     127.0.0.1:50594 - "[1mPOST /review-providers/14 HTTP/1.1[0m" [33m303 See Other[0m
[32mINFO[0m:     127.0.0.1:50594 - "[1mGET /status/9 HTTP/1.1[0m" [32m200 OK[0m
[32mINFO[0m:     127.0.0.1:50597 - "[1mGET /portal/3842f649-fcc0-43ac-98fe-087392ba67ff HTTP/1.1[0m" [32m200 OK[0m
[32mINFO[0m:     127.0.0.1:50603 - "[1mGET / HTTP/1.1[0m" [32m200 OK[0m
[32mINFO[0m:     127.0.0.1:50602 - "[1mGET /static/css/styles.css HTTP/1.1[0m" [32m200 OK[0m
[32mINFO[0m:     127.0.0.1:50603 - "[1mGET /favicon.ico HTTP/1.1[0m" [31m404 Not Found[0m
[32mINFO[0m:     127.0.0.1:50603 - "[1mGET /register HTTP/1.1[0m" [32m200 OK[0m
[32mINFO[0m:     127.0.0.1:50606 - "[1mPOST /register HTTP/1.1[0m" [33m303 See Other[0m
[32mINFO[0m:     127.0.0.1:50606 - "[1mGET /consent/15 HTTP/1.1[0m" [32m200 OK[0m
INFO:app.routers.web:‚úÖ Consent signed and professional PDF generated for patient 15
[32mINFO[0m:     127.0.0.1:50620 - "[1mPOST /consent/15 HTTP/1.1[0m" [33m303 See Other[0m
[32mINFO[0m:     127.0.0.1:50620 - "[1mGET /search-providers/15 HTTP/1.1[0m" [32m200 OK[0m
[32mINFO[0m:     127.0.0.1:50622 - "[1mPOST /search-providers/15 HTTP/1.1[0m" [91m500 Internal Server Error[0m
[31mERROR[0m:    Exception in ASGI application
Traceback (most recent call last):
  File "/Users/brandongaston/Downloads/medfax-app (4)/backend/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/httptools_impl.py", line 401, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/brandongaston/Downloads/medfax-app (4)/backend/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 70, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/brandongaston/Downloads/medfax-app (4)/backend/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/brandongaston/Downloads/medfax-app (4)/backend/.venv/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/brandongaston/Downloads/medfax-app (4)/backend/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 187, in __call__
    raise exc
  File "/Users/brandongaston/Downloads/medfax-app (4)/backend/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/brandongaston/Downloads/medfax-app (4)/backend/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 93, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
  File "/Users/brandongaston/Downloads/medfax-app (4)/backend/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 144, in simple_response
    await self.app(scope, receive, send)
  File "/Users/brandongaston/Downloads/medfax-app (4)/backend/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/brandongaston/Downloads/medfax-app (4)/backend/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 62, in wrapped_app
    raise exc
  File "/Users/brandongaston/Downloads/medfax-app (4)/backend/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 51, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/brandongaston/Downloads/medfax-app (4)/backend/.venv/lib/python3.11/site-packages/starlette/routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/brandongaston/Downloads/medfax-app (4)/backend/.venv/lib/python3.11/site-packages/starlette/routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "/Users/brandongaston/Downloads/medfax-app (4)/backend/.venv/lib/python3.11/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/brandongaston/Downloads/medfax-app (4)/backend/.venv/lib/python3.11/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/brandongaston/Downloads/medfax-app (4)/backend/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 62, in wrapped_app
    raise exc
  File "/Users/brandongaston/Downloads/medfax-app (4)/backend/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 51, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/brandongaston/Downloads/medfax-app (4)/backend/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/brandongaston/Downloads/medfax-app (4)/backend/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/brandongaston/Downloads/medfax-app (4)/backend/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/brandongaston/Library/Mobile Documents/com~apple~CloudDocs/PycharmProjects/Veritas_One_2025/backend/app/routers/web.py", line 351, in search_providers_submit
    hospitals = await search_hospital_by_name(search_query, limit=20)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: search_hospital_by_name() got an unexpected keyword argument 'limit'
[32mINFO[0m:     127.0.0.1:50626 - "[1mGET /review-providers/15 HTTP/1.1[0m" [32m200 OK[0m
INFO:app.routers.ifax:================================================================================
INFO:app.routers.ifax:üì® Incoming fax webhook received
INFO:app.routers.ifax:Headers: {'host': '39a4366f370c.ngrok.app', 'user-agent': 'curl/7.61.1', 'content-length': '297', 'accept': 'application/json', 'content-type': 'application/json', 'x-forwarded-for': '52.26.228.122', 'x-forwarded-host': '39a4366f370c.ngrok.app', 'x-forwarded-proto': 'https', 'accept-encoding': 'gzip'}
INFO:app.routers.ifax:Raw payload: {'jobId': 12345, 'faxCallLength': 59, 'faxCallStart': 1699574434, 'faxCallEnd': 1699574493, 'faxTotalPages': 1, 'success': True, 'fromNumber': '+19073131400', 'toNumber': '+19073131400', 'code': 0, 'message': 'NORMAL_CLEARING', 'faxReceivedPages': 1, 'faxStatus': 'received', 'direction': 'inbound', 'transactionId': 123123}
INFO:app.routers.ifax:‚úÖ Valid payload: JobID=12345, TransactionID=123123, From=+19073131400, Pages=1
INFO:app.routers.ifax:‚úÖ Created FaxFile record: ID=32, JobID=12345
INFO:app.routers.ifax:‚úÖ Queued background processing for FaxID=32, JobID=12345
INFO:app.routers.ifax:================================================================================
[32mINFO[0m:     52.26.228.122:0 - "[1mPOST /ifax/receive HTTP/1.1[0m" [32m200 OK[0m
INFO:app.routers.ifax:üöÄ Starting background processing for FaxID=32
INFO:app.services.fax_processor.IncomingFaxProcessor:üîÑ Starting fax processing: JobID=12345, FaxID=32
INFO:app.services.fax_processor.IncomingFaxProcessor:üì• Step 1/7: Downloading fax PDF...
INFO:app.services.ifax_service:Downloading fax: jobId=12345, transactionId=123123
ERROR:app.services.ifax_service:Fax download failed: {'status': 0, 'code': 120033, 'message': 'The fax does not exist'}
INFO:app.routers.ifax:‚úÖ Background processing complete for FaxID=32: {'success': False, 'fax_id': 32, 'patient_matched': False, 'patient_id': None, 'provider_matched': False, 'provider_request_ids': [], 'request_completed': False, 'completed_request_ids': [], 'encounter_date_found': False, 'errors': ['Download failed: Downloaded file not found or invalid path']}
ERROR:app.routers.ifax:‚ö†Ô∏è Processing had errors: ['Download failed: Downloaded file not found or invalid path']
INFO:app.services.ifax_service:Sending fax to: +1-938-336-4787 (formatted: +19383364787)
INFO:app.services.ifax_service:Added file to fax: cover_rr10_prov36.pdf (5388 chars)
INFO:app.services.ifax_service:Added file to fax: release_patient_15.pdf (8196 chars)
INFO:app.services.ifax_service:Webhook configured: https://veritasone.net/ifax/outbound-status
INFO:app.services.ifax_service:Sending fax request: {'faxNumber': '+19383364787', 'files': [{'name': 'cover_rr10_prov36.pdf', 'size': 5388}, {'name': 'release_patient_15.pdf', 'size': 8196}], 'coverPage': {'text': 'Medical Records Request for Test Three'}, 'webhook': {'statusUrl': 'https://veritasone.net/ifax/outbound-status'}}
INFO:app.services.ifax_service:iFax API response: 200
INFO:app.services.ifax_service:iFax API response data: {'status': 0, 'code': 12005, 'message': 'Not enough credits'}
ERROR:app.services.ifax_service:‚ùå Fax send failed: Not enough credits
ERROR:app.services.ifax_service:Full response: {'status': 0, 'code': 12005, 'message': 'Not enough credits'}
ERROR:app.routers.web:‚ùå Failed to send fax to test (Fax: +1-938-336-4787): Not enough credits
INFO:app.routers.web:‚úÖ Record request 10 created with 1 providers. Faxes sent with professional cover sheets and release forms.
[32mINFO[0m:     127.0.0.1:50708 - "[1mPOST /review-providers/15 HTTP/1.1[0m" [33m303 See Other[0m
[32mINFO[0m:     127.0.0.1:50708 - "[1mGET /status/10 HTTP/1.1[0m" [32m200 OK[0m
[32mINFO[0m:     127.0.0.1:51390 - "[1mGET /apple-touch-icon-precomposed.png HTTP/1.1[0m" [31m404 Not Found[0m
[32mINFO[0m:     127.0.0.1:51390 - "[1mGET /apple-touch-icon.png HTTP/1.1[0m" [31m404 Not Found[0m
